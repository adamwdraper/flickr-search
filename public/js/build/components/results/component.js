/**
 * Tiles - jQuery Plugin
 *
 * Version: 0.0.1 (5/25/2012)
 * Requires: jQuery v1.7+
 *
 * Copyright (c) 2011 User - http://github.com/username
 * Under MIT and GPL licenses:
 *  http://www.opensource.org/licenses/mit-license.php
 *  http://www.gnu.org/licenses/gpl.html
 */

(function(e){typeof define=="function"&&define.amd?define("libraries/jquery/plugins/tiles",["jquery"],e):e(jQuery)})(function(e){var t,n={imageHeight:250,margin:1},r=[],i=function(e){var t=n.imageHeight,r=(t/Number(e.height+n.margin*2)).toFixed(3);e.height=Number(e.height-n.margin*2)*r,e.width=Number(e.width-n.margin*2)*r},s=function(e,t,n){return Math.abs(e-n)>Math.abs(t-n)},o=function(e,t,n){var r;return function(){var s=this,o=arguments,u=function(){n||e.apply(s,o),r=null};r?clearTimeout(r):n&&e.apply(s,o),r=setTimeout(u,t||250)}},u=function(e){var n=t.width(),r=[],o={width:0,photos:[]};return e.forEach(function(e){i(e),s(o.width,o.width+e.width,n)?(o.photos.push(e),o.width=o.width+e.width):(r.push(o),o={width:e.width,photos:[e]})}),r},a=function(i){var s=t.width(),o=i?u(i):u(r);i||t.empty(),o.forEach(function(r){var i=s/r.width;r.photos.forEach(function(r){var s=e("<a></a>"),o=e("<img>");o.attr("src",r.src),n.margin&&o.css("margin",n.margin+"px"),o.width(Math.floor((r.width-n.margin*2)*i)),o.height(Math.floor((r.height-n.margin*2)*i)),o.on("load",function(){e(this).addClass("loaded")}),r.href&&s.attr("href",r.href).attr("target","_blank"),s.addClass("tile").html(o),t.append(s)})})},f=function(){a()},l={init:function(){return this.each(function(){t=e(this),t.data("initialized")||(t.data("initialized",!0),e(window).on("resize",o(f)))})},add:function(e){r=r.concat(e),a(e)},empty:function(){r=[],t.empty()}};e.fn.tiles=function(t){if(l[t])return l[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return l.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.plugin")}}),define("components/results/photo",["backbone"],function(e){var t=e.Model.extend({getUrl:function(){return this.get("url_z")},getDimensions:function(){return{height:Number(this.get("height_z")),width:Number(this.get("width_z"))}},getLink:function(){return"https://www.flickr.com/photos/"+this.get("owner")+"/"+this.get("id")}});return t}),define("components/results/photos",["backbone","utilities/flickr/utility","./photo"],function(e,t,n){var r=e.Collection.extend({model:n,url:function(){var e={method:"flickr.photos.search",api_key:t.api.key,text:this.app.get("keyword"),extras:"description, media, date_taken, owner_name, tags, url_z, url_c, url_l",format:"json",nojsoncallback:1,per_page:40,sort:"relevance",page:this.app.get("page")};return"https://api.flickr.com/services/rest/?"+$.param(e)},parse:function(e){return e.photos.photo}});return r}),define("components/results/component",["jquery","underscore","backbone","plugins/infinite-scroll/plugin","libraries/jquery/plugins/tiles","./photos"],function(e,t,n,r,i,s){var o=n.View.extend({collection:new s,listeners:{"app change:keyword":"nextKeyword","collection sync":"renderResults","collection reset":"renderResults",fetch:"fetch"},events:{},initialize:function(){t.bindAll(this,"fetch")},render:function(){return this.$container=this.$el.find("[data-container]"),this.$container.tiles(),this.plugins.infiniteScroll=(new r({el:this.$container})).render(),this.listenTo(this.plugins.infiniteScroll,"nearBottom",this.nextPage),this.trigger("fetch"),this},nextKeyword:function(){this.app.set("page",1),this.trigger("fetch")},nextPage:function(){var e=this.app.get("page");this.app.set("page",e+1),this.trigger("fetch")},fetch:t.debounce(function(){this.app.get("keyword")?this.collection.fetch():this.collection.length&&this.collection.reset()},500),renderResults:function(){var e=[];this.collection.each(function(t){var n=t.getDimensions();e.push({src:t.getUrl(),href:t.getLink(),height:n.height,width:n.width})}),this.app.get("page")===1&&this.$container.tiles("empty"),this.$container.tiles("add",e),this.plugins.infiniteScroll.trigger("reset")}});return o});